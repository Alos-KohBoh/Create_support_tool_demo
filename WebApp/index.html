<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>制作補助ツール</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>制作補助ツール</h1>
            <p class="subtitle">ガチャシミュレーション / データ管理 / プロット作成</p>
        </header>

        <!-- ホーム画面 -->
        <div id="homeScreen" class="home-screen">
            <div class="home-cards">
                <div class="home-card" data-section="simulation-section">
                    <div class="home-card-icon">📊</div>
                    <h2>シミュレーション</h2>
                    <p>ガチャシミュレーションと鞄管理</p>
                </div>
                <div class="home-card" data-section="data-section">
                    <div class="home-card-icon">📝</div>
                    <h2>データ作成・管理</h2>
                    <p>キャラクター・モンスター・アイテム管理</p>
                </div>
                <div class="home-card" data-section="plot-section">
                    <div class="home-card-icon">📖</div>
                    <h2>プロット作成・管理</h2>
                    <p>ストーリー構成とシーン管理</p>
                </div>
            </div>
        </div>

        <!-- シミュレーションセクション -->
        <div id="simulation-section" class="section-screen" style="display: none;">
            <div class="section-header">
                <button class="btn-back" data-back="home">← ホームに戻る</button>
                <h2>シミュレーション</h2>
            </div>
            <main>
                <!-- コントロールパネル -->
                <section class="control-panel">
                    <!-- タブナビゲーション -->
                    <div class="main-tabs">
                        <button class="main-tab-btn active" data-tab="simulation">ガチャ</button>
                        <button class="main-tab-btn" data-tab="bag">鞄</button>
                    </div>

                    <!-- シミュレーションタブ -->
                    <div id="simulation" class="main-tab-content active">
                        <div class="card">
                            <h2>シミュレーション設定</h2>
                        
                        <div class="form-group">
                            <label for="monsterSelect">モンスター選択</label>
                            <select id="monsterSelect" class="form-control">
                                <option value="">-- モンスターを選択 --</option>
                            </select>
                        </div>

                        <div id="monsterInfo" class="monster-info" style="display: none;">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">危険度:</span>
                                    <span id="monsterDanger" class="info-value"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">レア度:</span>
                                    <span id="monsterRarity" class="info-value"></span>
                                </div>
                            </div>
                            
                            <div id="monsterDescriptionDisplay" class="description-text" style="display: none;"></div>
                            
                            <h3>ドロップテーブル</h3>
                            <div id="dropTable" class="drop-table"></div>
                        </div>

                        <div class="form-group">
                            <label for="simulationCharacterSelect">獲得キャラクター</label>
                            <select id="simulationCharacterSelect" class="form-control">
                                <option value="">-- 倉庫（共通） --</option>
                            </select>
                            <p class="help-text" style="margin-top: 5px; font-size: 0.85em; color: #666;">
                                アイテムを獲得するキャラクターを選択（未選択時は倉庫）
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="monsterLevel">モンスターレベル</label>
                            <input type="number" id="monsterLevel" class="form-control" value="1" min="1" max="9999">
                            <p class="help-text" style="margin-top: 5px; font-size: 0.85em; color: #666;">
                                レベルが高いほどドロップ確率が上昇（最大300%）
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="trialCount">試行回数</label>
                            <input type="number" id="trialCount" class="form-control" value="100" min="1" max="100000">
                        </div>

                        <div class="button-group">
                            <button id="runSimulation" class="btn btn-primary" disabled>
                                ガチャ開始
                            </button>
                            <button id="calculateExpected" class="btn btn-secondary" disabled>
                                期待値計算
                            </button>
                            <button id="clearResults" class="btn btn-danger">
                                結果クリア
                            </button>
                        </div>
                        </div>
                    </div>

                    <!-- 鞄タブ -->
                    <div id="bag" class="main-tab-content">
                        <div class="card">
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label for="bagCharacterSelect">鞄の所有者</label>
                                <select id="bagCharacterSelect" class="form-control">
                                    <option value="">-- 倉庫（共通） --</option>
                                </select>
                            </div>
                            
                            <h2 id="bagTitle" style="margin-bottom: 15px;">倉庫</h2>
                            
                            <div class="bag-capacity">
                                <div class="bag-capacity-info">
                                    <div class="capacity-item">
                                        <label>現在:</label>
                                        <span id="currentCount" class="capacity-number">0</span>個
                                    </div>
                                    <div class="capacity-item">
                                        <label>最大:</label>
                                        <span id="maxCapacity" class="capacity-number">1000</span>個
                                    </div>
                                </div>
                                <div class="bag-controls">
                                    <button id="addBagItemBtn" class="btn btn-success">アイテム追加</button>
                                    <button id="bagSettingsBtn" class="btn btn-secondary">設定</button>
                                    <button id="clearBagBtn" class="btn btn-danger">クリア</button>
                                </div>
                            </div>

                            <div id="bagItemsList" class="bag-items-list">
                                <div class="empty-message">鞄は空です</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 結果表示エリア(シミュレーションタブのみ表示) -->
                <section class="results-section" id="resultsSection">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="results">集計結果</button>
                        <button class="tab-btn" data-tab="expected">期待値</button>
                        <button class="tab-btn" data-tab="log">ログ</button>
                        <button class="tab-btn" data-tab="chart">グラフ</button>
                    </div>

                    <!-- 集計結果タブ -->
                    <div id="results" class="tab-content active">
                        <div class="card">
                            <div class="card-header-with-action">
                                <h2>集計結果</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button id="addExpToCharacter" class="btn btn-info" style="display: none;">
                                        経験値を獲得
                                    </button>
                                    <button id="addResultsToBag" class="btn btn-success" style="display: none;">
                                        すべて鞄に入れる
                                    </button>
                                </div>
                            </div>
                            <div id="resultsContent" class="results-content">
                                <p class="empty-message">ガチャを実行してください</p>
                            </div>
                        </div>
                    </div>

                    <!-- 期待値タブ -->
                    <div id="expected" class="tab-content">
                        <div class="card">
                            <h2>期待値</h2>
                            <div id="expectedContent" class="results-content">
                                <p class="empty-message">期待値を計算してください</p>
                            </div>
                        </div>
                    </div>

                    <!-- ログタブ -->
                    <div id="log" class="tab-content">
                        <div class="card">
                            <h2>ガチャログ (最新100件)</h2>
                            <div id="logContent" class="log-content">
                                <p class="empty-message">ガチャ履歴がありません</p>
                            </div>
                        </div>
                    </div>

                    <!-- グラフタブ -->
                    <div id="chart" class="tab-content">
                        <div class="card">
                            <h2>ドロップ分布グラフ</h2>
                            <canvas id="dropChart"></canvas>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- データ作成・管理セクション -->
        <div id="data-section" class="section-screen" style="display: none;">
            <div class="section-header">
                <button class="btn-back" data-back="home">← ホームに戻る</button>
                <h2>データ作成・管理</h2>
            </div>
            
            <!-- サブタブ -->
            <div class="main-tabs">
                <button class="main-tab-btn active" data-tab="characters">キャラクター</button>
                <button class="main-tab-btn" data-tab="monsters">モンスター</button>
                <button class="main-tab-btn" data-tab="items">アイテム</button>
                <button class="main-tab-btn" data-tab="master">マスタ設定</button>
                <button class="main-tab-btn" data-tab="system">システム</button>
            </div>

            <!-- キャラクタータブ（新規） -->
            <div id="characters" class="main-tab-content active">
                <div class="card">
                    <div class="list-header">
                        <h2>キャラクター一覧</h2>
                        <button id="addCharacterBtn" class="btn btn-success">
                            キャラクター追加
                        </button>
                    </div>
                    
                    <!-- フィルター -->
                    <div class="filter-bar">
                        <input type="text" id="characterNameFilter" class="filter-input" placeholder="名前で検索...">
                        <select id="characterJobFilter" class="filter-select">
                            <option value="">職業: すべて</option>
                        </select>
                        <select id="characterRaceFilter" class="filter-select">
                            <option value="">種族: すべて</option>
                        </select>
                        <select id="characterTagFilter" class="filter-select">
                            <option value="">タグ: すべて</option>
                        </select>
                        <button id="clearCharacterFilter" class="btn btn-secondary btn-sm">フィルタクリア</button>
                    </div>

                    <div id="characterListView" class="data-list-view">
                        <div class="empty-message">キャラクターが登録されていません</div>
                    </div>

                    <!-- 関係性マップセクション -->
                    <div class="relationship-section" style="margin-top: 30px;">
                        <div class="list-header">
                            <h2>キャラクター関係性マップ</h2>
                            <button id="addRelationshipBtn" class="btn btn-success">
                                関係性を追加
                            </button>
                        </div>
                        <div id="relationshipListView" class="data-list-view">
                            <div class="empty-message">関係性が登録されていません</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- モンスタータブ -->
            <div id="monsters" class="main-tab-content">
                <div class="card">
                    <div class="list-header">
                        <h2>モンスター一覧</h2>
                        <button id="addMonsterBtn" class="btn btn-success">
                            モンスター追加
                        </button>
                    </div>
                    
                    <!-- フィルター -->
                    <div class="filter-bar">
                        <input type="text" id="monsterNameFilter" class="filter-input" placeholder="名前で検索...">
                        <select id="monsterDangerFilter" class="filter-select">
                            <option value="">危険度: すべて</option>
                        </select>
                        <select id="monsterRarityFilter" class="filter-select">
                            <option value="">レア度: すべて</option>
                        </select>
                        <button id="clearMonsterFilter" class="btn btn-secondary btn-sm">フィルタクリア</button>
                    </div>

                    <div id="monsterListView" class="data-list-view">
                        <!-- モンスター一覧を動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- アイテムタブ -->
            <div id="items" class="main-tab-content">
                <div class="card">
                    <div class="list-header">
                        <h2>アイテム一覧</h2>
                        <button id="addItemBtn" class="btn btn-success">
                            アイテム追加
                        </button>
                    </div>

                    <!-- フィルター -->
                    <div class="filter-bar">
                        <input type="text" id="itemNameFilter" class="filter-input" placeholder="名前で検索...">
                        <select id="itemTypeFilter" class="filter-select">
                            <option value="">種類: すべて</option>
                        </select>
                        <select id="itemRarityFilter" class="filter-select">
                            <option value="">レア度: すべて</option>
                        </select>
                        <button id="clearItemFilter" class="btn btn-secondary btn-sm">フィルタクリア</button>
                    </div>

                    <div id="itemListView" class="data-list-view">
                        <!-- アイテム一覧を動的に生成 -->
                    </div>
                </div>
            </div>

            <!-- マスタ設定タブ -->
            <div id="master" class="main-tab-content">
                <div class="card">
                    <h2>マスタ情報管理</h2>
                    
                    <!-- モンスター設定可能項目 -->
                    <div class="master-section">
                        <h3>モンスター項目設定</h3>
                        <div class="master-fields-list" id="monsterFieldsList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addMonsterFieldBtn" class="btn btn-info">
                            モンスター項目を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- アイテム設定可能項目 -->
                    <div class="master-section">
                        <h3>アイテム項目設定</h3>
                        <div class="master-fields-list" id="itemFieldsList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addItemFieldBtn" class="btn btn-info">
                            アイテム項目を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- レアリティ管理 -->
                    <div class="master-section">
                        <h3>レアリティ設定（モンスター）</h3>
                        <div class="rarity-list" id="monsterRarityList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addMonsterRarityBtn" class="btn btn-info">
                            モンスターレアリティを追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <div class="master-section">
                        <h3>レアリティ設定（アイテム）</h3>
                        <div class="rarity-list" id="itemRarityList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addItemRarityBtn" class="btn btn-info">
                            アイテムレアリティを追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- 危険度管理 -->
                    <div class="master-section">
                        <h3>危険度設定</h3>
                        <div class="danger-list" id="dangerLevelList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addDangerLevelBtn" class="btn btn-info">
                            危険度を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- アイテム種類管理 -->
                    <div class="master-section">
                        <h3>アイテム種類設定</h3>
                        <div class="item-type-list" id="itemTypeList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addItemTypeBtn" class="btn btn-info">
                            アイテム種類を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- キャラクター職業管理 -->
                    <div class="master-section">
                        <h3>キャラクター職業設定</h3>
                        <div class="character-job-list" id="characterJobList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addCharacterJobBtn" class="btn btn-info">
                            職業を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- キャラクター種族管理 -->
                    <div class="master-section">
                        <h3>キャラクター種族設定</h3>
                        <div class="character-race-list" id="characterRaceList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addCharacterRaceBtn" class="btn btn-info">
                            種族を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- キャラクター属性管理 -->
                    <div class="master-section">
                        <h3>キャラクター属性設定</h3>
                        <div class="character-element-list" id="characterElementList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addCharacterElementBtn" class="btn btn-info">
                            属性を追加
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 1px solid var(--border-color);">

                    <!-- キャラクターステータス項目管理 -->
                    <div class="master-section">
                        <h3>キャラクターステータス項目設定</h3>
                        <div class="character-stats-list" id="characterStatsList">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="addCharacterStatBtn" class="btn btn-info">
                            ステータス項目を追加
                        </button>
                    </div>

                    <div class="master-section">
                        <h3>職業ごとのレベルアップボーナス設定</h3>
                        <div id="jobBonusesList">
                            <!-- 動的に生成 -->
                        </div>
                    </div>

                    <div class="master-section">
                        <h3>種族ごとのレベルアップボーナス設定</h3>
                        <div id="raceBonusesList">
                            <!-- 動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- システムタブ -->
            <div id="system" class="main-tab-content">
                <div class="card">
                    <h2>システム</h2>
                    
                    <div class="system-section">
                        <h3>プロジェクト管理</h3>
                        <div class="form-group">
                            <label for="currentProjectSelect">現在のプロジェクト</label>
                            <select id="currentProjectSelect" class="form-control">
                            </select>
                        </div>
                        <div class="button-group">
                            <button id="newProjectBtn" class="btn btn-primary">
                                ➕ 新しいプロジェクト
                            </button>
                            <button id="editProjectBtn" class="btn btn-secondary">
                                ✏️ プロジェクト編集
                            </button>
                            <button id="deleteProjectBtn" class="btn btn-danger">
                                🗑️ プロジェクト削除
                            </button>
                            <button id="exportProjectBtn" class="btn btn-info">
                                📤 プロジェクトをエクスポート
                            </button>
                            <button id="importProjectBtn" class="btn btn-info">
                                📥 プロジェクトをインポート
                            </button>
                        </div>
                        <input type="file" id="importProjectInput" accept=".json" style="display: none;">
                        <div id="projectInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                            <p id="projectInfoText">プロジェクト情報を読み込み中...</p>
                        </div>
                    </div>
                    
                    <div class="system-section">
                        <h3>自動バックアップ</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="autoBackupEnabled" checked>
                                自動バックアップを有効にする
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="autoBackupInterval">バックアップ間隔（分）</label>
                            <input type="number" id="autoBackupInterval" class="form-control" value="30" min="5" max="1440" style="width: 150px;">
                        </div>
                        <button id="saveBackupSettings" class="btn btn-primary">設定を保存</button>
                        <div id="backupInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                            <p><strong>バックアップ情報：</strong></p>
                            <p id="backupInfoText">読み込み中...</p>
                        </div>
                    </div>

                    <div class="system-section">
                        <h3>手動バックアップ</h3>
                        <div class="button-group">
                            <button id="createBackupBtn" class="btn btn-success">
                                💾 バックアップを作成
                            </button>
                            <button id="restoreBackupBtn" class="btn btn-warning">
                                📂 バックアップから復元
                            </button>
                        </div>
                        <input type="file" id="restoreBackupInput" accept=".json" style="display: none;">
                        <p class="help-text">
                            バックアップ作成: すべてのデータをJSONファイルとしてダウンロード<br>
                            バックアップ復元: JSONファイルからデータを完全復元
                        </p>
                    </div>
                    
                    <div class="system-section">
                        <h3>データバックアップ（旧）</h3>
                        <div class="button-group">
                            <button id="exportDataBtn" class="btn btn-info">
                                データをエクスポート
                            </button>
                            <button id="importDataBtn" class="btn btn-info">
                                データをインポート
                            </button>
                        </div>
                        <input type="file" id="importFileInput" accept=".json" style="display: none;">
                        <p class="help-text">
                            エクスポート: すべてのデータをJSONファイルとしてダウンロード<br>
                            インポート: JSONファイルからデータを復元
                        </p>
                    </div>

                    <div class="system-section">
                        <h3>データリセット</h3>
                        <div class="button-group">
                            <button id="resetDataBtn" class="btn btn-danger">
                                データリセット
                            </button>
                        </div>
                        <p class="help-text">
                            すべてのデータを削除してサンプルデータを再読み込みします
                        </p>
                    </div>

                    <div class="system-section">
                        <h3>🤝 作品共有機能</h3>
                        <p class="help-text">
                            作品データをエクスポートして他の人と共有できます。<br>
                            共有リンクを生成してコラボレーターと作品を編集できます。
                        </p>
                        <div class="form-group">
                            <label for="shareWorkSelect">共有する作品</label>
                            <select id="shareWorkSelect" class="form-control">
                                <option value="">-- 作品を選択 --</option>
                            </select>
                        </div>
                        <div class="button-group">
                            <button id="generateShareLinkBtn" class="btn btn-primary">
                                🔗 共有リンクを生成
                            </button>
                            <button id="exportWorkBtn" class="btn btn-success">
                                💾 作品をエクスポート
                            </button>
                            <button id="importSharedWorkBtn" class="btn btn-info">
                                📥 共有作品をインポート
                            </button>
                        </div>
                        <input type="file" id="importSharedWorkInput" accept=".json" style="display: none;">
                        <div id="shareLinkResult" class="share-link-box" style="display: none;">
                            <h4>共有リンク</h4>
                            <div class="share-link-display">
                                <input type="text" id="shareLinkInput" class="form-control" readonly>
                                <button class="btn btn-secondary btn-sm" onclick="app.copyShareLink()">📋 コピー</button>
                            </div>
                            <p class="help-text">このリンクをコラボレーターと共有してください。</p>
                        </div>
                    </div>

                    <div class="system-section">
                        <h3>📝 出力・公開機能</h3>
                        <p class="help-text">
                            作品を様々な形式で出力して、公開や印刷ができます。
                        </p>
                        <div class="form-group">
                            <label for="outputWorkSelect">出力する作品</label>
                            <select id="outputWorkSelect" class="form-control">
                                <option value="">-- 作品を選択 --</option>
                            </select>
                        </div>
                        <div class="button-group">
                            <button id="generatePDFBtn" class="btn btn-danger">
                                📝 PDF出力
                            </button>
                            <button id="generateHTMLBtn" class="btn btn-success">
                                🌐 HTML公開用ファイル生成
                            </button>
                            <button id="previewWorkBtn" class="btn btn-info">
                                👁️ プレビュー
                            </button>
                        </div>
                        <div id="outputOptions" class="output-options">
                            <h4>出力オプション</h4>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" id="includeCharacters" checked>
                                    キャラクター情報を含める
                                </label>
                                <label>
                                    <input type="checkbox" id="includeImages" checked>
                                    画像を含める
                                </label>
                                <label>
                                    <input type="checkbox" id="includeAnalytics">
                                    統計情報を含める
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="system-section">
                        <h3>📊 統計グラフ</h3>
                        <p class="help-text">
                            作品の統計データをグラフ化して視覚的に表示します。
                        </p>
                        <div class="form-group">
                            <label for="statsWorkSelect">分析する作品</label>
                            <select id="statsWorkSelect" class="form-control">
                                <option value="">-- 作品を選択 --</option>
                            </select>
                        </div>
                        <button id="showStatsBtn" class="btn btn-primary">
                            📊 統計グラフを表示
                        </button>
                        <div id="statsGraphs" class="stats-graphs" style="display: none;">
                            <div class="stats-grid">
                                <div class="stats-card">
                                    <h4>章別文字数</h4>
                                    <canvas id="chapterWordsChart"></canvas>
                                </div>
                                <div class="stats-card">
                                    <h4>キャラクター登場回数</h4>
                                    <canvas id="characterAppearanceChart"></canvas>
                                </div>
                                <div class="stats-card">
                                    <h4>執筆進捗状況</h4>
                                    <canvas id="progressChart"></canvas>
                                </div>
                                <div class="stats-card">
                                    <h4>章別シーン数</h4>
                                    <canvas id="chapterScenesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="system-section">
                        <h3>📋 テンプレート管理</h3>
                        <p class="help-text">
                            よく使うキャラクター設定や章構成をテンプレートとして保存し、再利用できます。
                        </p>
                        
                        <!-- キャラクターテンプレート -->
                        <div class="template-section">
                            <h4>キャラクターテンプレート</h4>
                            <div class="form-group">
                                <label for="characterTemplateSelect">キャラクターを選択</label>
                                <select id="characterTemplateSelect" class="form-control">
                                    <option value="">-- キャラクターを選択 --</option>
                                </select>
                            </div>
                            <div class="button-group">
                                <button id="saveCharacterTemplateBtn" class="btn btn-success">
                                    💾 テンプレートとして保存
                                </button>
                                <button id="loadCharacterTemplateBtn" class="btn btn-info">
                                    📂 テンプレートから作成
                                </button>
                            </div>
                            <div id="characterTemplateList" class="template-list">
                                <h5>保存済みテンプレート</h5>
                                <div id="characterTemplates"></div>
                            </div>
                        </div>

                        <!-- 章構成テンプレート -->
                        <div class="template-section">
                            <h4>章構成テンプレート</h4>
                            <div class="form-group">
                                <label for="chapterTemplateWork">作品を選択</label>
                                <select id="chapterTemplateWork" class="form-control">
                                    <option value="">-- 作品を選択 --</option>
                                </select>
                            </div>
                            <div class="button-group">
                                <button id="saveChapterTemplateBtn" class="btn btn-success">
                                    💾 章構成をテンプレート化
                                </button>
                                <button id="loadChapterTemplateBtn" class="btn btn-info">
                                    📂 テンプレートを適用
                                </button>
                            </div>
                            <div id="chapterTemplateList" class="template-list">
                                <h5>保存済みテンプレート</h5>
                                <div id="chapterTemplates"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- プロット作成・管理セクション -->
        <div id="plot-section" class="section-screen" style="display: none;">
            <!-- 作品一覧画面 -->
            <div id="work-list-screen" class="plot-screen active">
                <div class="section-header">
                    <button class="btn-back" data-back="home">← ホームに戻る</button>
                    <h2>プロット作成・管理</h2>
                </div>
                
                <div class="card">
                    <div class="list-header">
                        <h2>作品一覧</h2>
                        <button id="addWorkBtn" class="btn btn-success">
                            新規作品を作成
                        </button>
                    </div>
                    
                    <div id="workListView" class="data-list-view">
                        <div class="empty-message">作品が作成されていません</div>
                    </div>
                </div>
            </div>

            <!-- 章管理画面 -->
            <div id="chapter-edit-screen" class="plot-screen" style="display: none;">
                <div class="section-header">
                    <button class="btn-back" onclick="app.backToWorkList()">← 作品一覧に戻る</button>
                    <div class="current-work-header" id="currentWorkHeader">
                        <h2 id="currentWorkTitle">作品タイトル</h2>
                        <div class="plot-export-buttons">
                            <button onclick="app.exportPlotToText()" class="btn btn-secondary btn-sm">
                                📋 テキストコピー
                            </button>
                            <button onclick="app.exportPlotToFile()" class="btn btn-secondary btn-sm">
                                💾 ファイル出力
                            </button>
                        </div>
                        <span class="badge badge-info" id="currentWorkGenre"></span>
                    </div>
                </div>
                
                <!-- タブメニュー -->
                <div class="main-tabs">
                    <button class="main-tab-btn active" data-tab="chapters-content">章/エピソード</button>
                    <button class="main-tab-btn" data-tab="scene-cards-content">シーンカード</button>
                    <button class="main-tab-btn" data-tab="timeline-content">タイムライン</button>
                    <button class="main-tab-btn" data-tab="plot-analytics-content">分析</button>
                    <button class="main-tab-btn" data-tab="ai-assistance-content">AI支援</button>
                    <button class="main-tab-btn" data-tab="comments-content">コメント</button>
                    <button class="main-tab-btn" data-tab="history-content">履歴</button>
                    <button class="main-tab-btn" data-tab="worldmap-content">世界観</button>
                </div>

                <!-- 章管理タブ -->
                <div id="chapters-content" class="main-tab-content active">
                    <div class="card">
                        <div class="list-header">
                            <h2>章/エピソード管理</h2>
                            <button id="addChapterBtn" class="btn btn-success">
                                章を追加
                            </button>
                        </div>
                        
                        <div id="chapterListView" class="data-list-view">
                            <div class="empty-message">章が作成されていません</div>
                        </div>
                    </div>
                </div>

                <!-- シーンカードタブ -->
                <div id="scene-cards-content" class="main-tab-content" style="display: none;">
                    <div class="card">
                        <div class="list-header">
                            <h2>シーンカードビュー</h2>
                            <select id="sceneCardChapterFilter" class="form-control" style="width: 250px;">
                                <option value="">すべての章</option>
                            </select>
                        </div>
                        <div id="sceneCardsView" class="scene-cards-container">
                            <div class="empty-message">シーンが作成されていません</div>
                        </div>
                    </div>
                </div>

                <!-- タイムラインタブ -->
                <div id="timeline-content" class="main-tab-content" style="display: none;">
                    <div class="card">
                        <div class="list-header">
                            <h2>タイムライン</h2>
                            <button id="addTimelineEventBtn" class="btn btn-success">
                                イベントを追加
                            </button>
                        </div>
                        
                        <div id="timelineView" class="timeline-view">
                            <div class="empty-message">タイムラインイベントが作成されていません</div>
                        </div>
                    </div>
                </div>

                <!-- プロット分析タブ -->
                <div id="plot-analytics-content" class="main-tab-content" style="display: none;">
                    <div class="card">
                        <h2>プロット分析</h2>
                        <div id="plotAnalyticsView" class="analytics-container">
                            <!-- 動的に生成 -->
                        </div>
                    </div>
                </div>

                <!-- AI支援タブ -->
                <div id="ai-assistance-content" class="main-tab-content" style="display: none;">
                    <div class="card">
                        <h2>AI執筆支援</h2>
                        
                        <!-- プロット生成支援 -->
                        <div class="ai-section">
                            <h3>📖 プロット生成支援</h3>
                            <p class="help-text">作品の設定を元に、AIがプロットのアイデアを提案します。</p>
                            <div class="form-group">
                                <label for="plotPrompt">プロット生成のヒント（オプション）</label>
                                <textarea id="plotPrompt" class="form-control" rows="3" placeholder="例: 主人公が敵と和解するシーン、大きな転機となる出来事など"></textarea>
                            </div>
                            <button id="generatePlotBtn" class="btn btn-primary">
                                💡 プロットアイデアを生成
                            </button>
                            <div id="plotSuggestions" class="ai-result-box" style="display: none;">
                                <h4>生成されたプロット案</h4>
                                <div id="plotSuggestionsContent"></div>
                                <button class="btn btn-success btn-sm" onclick="app.addSuggestionAsChapter()">章として追加</button>
                            </div>
                        </div>

                        <hr style="margin: 30px 0;">

                        <!-- キャラクター台詞提案 -->
                        <div class="ai-section">
                            <h3>💬 キャラクター台詞提案</h3>
                            <p class="help-text">キャラクターの性格に基づいた台詞のバリエーションを提案します。</p>
                            <div class="form-group">
                                <label for="dialogueCharacterSelect">キャラクター選択</label>
                                <select id="dialogueCharacterSelect" class="form-control">
                                    <option value="">-- キャラクターを選択 --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dialogueSituation">状況・シチュエーション</label>
                                <textarea id="dialogueSituation" class="form-control" rows="2" placeholder="例: 仲間を励ますシーン、敵に宣戦布告する場面など"></textarea>
                            </div>
                            <button id="generateDialogueBtn" class="btn btn-primary">
                                💬 台詞案を生成
                            </button>
                            <div id="dialogueSuggestions" class="ai-result-box" style="display: none;">
                                <h4>提案された台詞</h4>
                                <div id="dialogueSuggestionsContent"></div>
                            </div>
                        </div>

                        <hr style="margin: 30px 0;">

                        <!-- 設定矛盾チェック -->
                        <div class="ai-section">
                            <h3>🔍 設定矛盾チェック</h3>
                            <p class="help-text">作品内の設定やキャラクター描写に矛盾がないかAIがチェックします。</p>
                            <button id="checkConsistencyBtn" class="btn btn-primary">
                                🔍 矛盾をチェック
                            </button>
                            <div id="consistencyResults" class="ai-result-box" style="display: none;">
                                <h4>チェック結果</h4>
                                <div id="consistencyResultsContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- コメント・レビュータブ -->
                <div id="comments-content" class="main-tab-content" style="display: none;">
                    <div class="card">
                        <h2>💬 コメント・レビュー</h2>
                        
                        <!-- コメント対象選択 -->
                        <div class="form-group">
                            <label for="commentChapterSelect">章を選択</label>
                            <select id="commentChapterSelect" class="form-control">
                                <option value="">-- 章を選択 --</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="commentSceneSelect">シーンを選択（オプション）</label>
                            <select id="commentSceneSelect" class="form-control">
                                <option value="">-- 全体コメント --</option>
                            </select>
                        </div>
                        
                        <!-- コメント入力 -->
                        <div class="form-group">
                            <label for="commentText">コメント</label>
                            <textarea id="commentText" class="form-control" rows="4" placeholder="コメントやレビューを入力してください..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="commentAuthor">コメント者名</label>
                            <input type="text" id="commentAuthor" class="form-control" placeholder="あなたの名前">
                        </div>
                        
                        <button id="addCommentBtn" class="btn btn-primary">
                            💬 コメントを追加
                        </button>
                        
                        <!-- コメント一覧 -->
                        <div id="commentsList" class="comments-list" style="margin-top: 30px;">
                            <h3>コメント一覧</h3>
                            <div id="commentsView">
                                <div class="empty-message">コメントがありません</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 変更履歴タブ -->
                <div id="history-content" class="main-tab-content" style="display: none;">
                    <div class="card">
                        <div class="list-header">
                            <h2>📜 変更履歴</h2>
                            <button id="clearHistoryBtn" class="btn btn-danger btn-sm">
                                履歴をクリア
                            </button>
                        </div>
                        
                        <!-- フィルター -->
                        <div class="filter-bar">
                            <select id="historyTypeFilter" class="filter-select">
                                <option value="">すべての変更</option>
                                <option value="chapter">章の変更</option>
                                <option value="scene">シーンの変更</option>
                                <option value="character">キャラクターの変更</option>
                            </select>
                            <select id="historyActionFilter" class="filter-select">
                                <option value="">すべての操作</option>
                                <option value="create">作成</option>
                                <option value="update">更新</option>
                                <option value="delete">削除</option>
                            </select>
                        </div>
                        
                        <!-- 履歴一覧 -->
                        <div id="historyView" class="history-list">
                            <div class="empty-message">変更履歴がありません</div>
                        </div>
                    </div>
                </div>

                <!-- ワールドマップタブ -->
                <div id="worldmap-content" class="main-tab-content" style="display: none;">
                    <!-- 世界観設定セクション -->
                    <div class="card world-setting-section">
                        <h2>📖 世界観設定</h2>
                        <div class="form-group">
                            <label for="worldSettingText">作品全体の世界観・設定</label>
                            <textarea id="worldSettingText" class="form-control" rows="8" placeholder="時代背景、魔法体系、社会構造、歴史、文化など、作品全体の世界観を記述してください..."></textarea>
                        </div>
                        <button id="saveWorldSettingBtn" class="btn btn-success">
                            💾 世界観設定を保存
                        </button>
                        <small class="text-muted" style="margin-left: 10px;">最終更新: <span id="worldSettingLastUpdate">未保存</span></small>
                    </div>

                    <!-- 地理・場所管理セクション -->
                    <div class="card">
                        <div class="list-header">
                            <h2>🗺️ 地理・場所管理</h2>
                            <button id="addLocationBtn" class="btn btn-success">
                                場所を追加
                            </button>
                        </div>

                        <!-- フィルター -->
                        <div class="filter-bar">
                            <select id="locationTypeFilter" class="filter-select">
                                <option value="">すべてのタイプ</option>
                                <option value="city">都市</option>
                                <option value="dungeon">ダンジョン</option>
                                <option value="nature">自然</option>
                                <option value="building">建物</option>
                                <option value="other">その他</option>
                            </select>
                            <input type="text" id="locationSearchInput" class="filter-input" placeholder="場所名で検索...">
                        </div>

                        <!-- 地理関係図 -->
                        <div class="worldmap-view">
                            <div id="locationsList" class="locations-grid">
                                <div class="empty-message">場所が登録されていません</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- キャラクター追加モーダル（新規） -->
    <div id="characterModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>キャラクター作成</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-columns">
                    <div class="form-column">
                        <h3>基本情報</h3>
                        <div class="form-group">
                            <label for="characterName">キャラクター名</label>
                            <input type="text" id="characterName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="characterJob">職業</label>
                            <select id="characterJob" class="form-control">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="characterRace">種族</label>
                            <select id="characterRace" class="form-control">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="characterElement">属性</label>
                            <select id="characterElement" class="form-control">
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="characterLevel">レベル</label>
                            <input type="number" id="characterLevel" class="form-control" value="1" min="1">
                        </div>
                        <div class="form-group">
                            <label for="characterImage">画像 (任意)</label>
                            <div class="image-input-group">
                                <input type="text" id="characterImage" class="form-control" placeholder="画像URLまたはBase64データ" readonly>
                                <button type="button" id="char-image-select-btn" class="btn btn-secondary btn-sm">画像選択</button>
                            </div>
                            <small class="form-help">画像選択ボタンから、URL指定・ファイルアップロード・ライブラリから選択できます</small>
                        </div>
                    </div>
                    <div class="form-column">
                        <h3>パラメータ</h3>
                        <div id="characterStatsFields">
                            <!-- 動的に生成 -->
                        </div>
                        <div id="bonusPointsSection" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; display: none;">
                            <h4>ボーナスポイント振り分け</h4>
                            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <strong>残りポイント: <span id="remainingBonusPoints">0</span></strong>
                                <button type="button" class="btn btn-warning btn-sm" onclick="app.resetBonusPoints()">リセット</button>
                            </div>
                            <div id="bonusAllocationFields">
                                <!-- 動的に生成 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="characterPersonality">性格</label>
                    <input type="text" id="characterPersonality" class="form-control" placeholder="例: 勇敢で正義感が強い">
                </div>
                <div class="form-group">
                    <label for="characterBackground">背景ストーリー</label>
                    <textarea id="characterBackground" class="form-control" rows="4" placeholder="キャラクターの過去や背景を記述"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterDialogues">セリフ集 (改行で区切る)</label>
                    <textarea id="characterDialogues" class="form-control" rows="4" placeholder="セリフ1&#10;セリフ2&#10;セリフ3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterSkills">スキル/特技 (改行で区切る)</label>
                    <textarea id="characterSkills" class="form-control" rows="3" placeholder="ファイアボール&#10;回復魔法&#10;剣術"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterTags">タグ (カンマで区切る)</label>
                    <input type="text" id="characterTags" class="form-control" placeholder="例: 主人公, 戦士, 仲間">
                    <small class="form-help">タグを使ってキャラクターを分類・検索できます</small>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveCharacter" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 作品作成モーダル -->
    <div id="workModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>作品作成</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="workTitle">作品タイトル</label>
                    <input type="text" id="workTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="workGenre">ジャンル</label>
                    <select id="workGenre" class="form-control">
                        <option value="">-- ジャンルを選択 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="workDescription">説明</label>
                    <textarea id="workDescription" class="form-control" rows="4" placeholder="作品の概要を記述"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveWork" class="btn btn-primary">作成</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 章追加モーダル -->
    <div id="chapterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>章作成</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="chapterTitle">章タイトル</label>
                    <input type="text" id="chapterTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="chapterDescription">説明</label>
                    <textarea id="chapterDescription" class="form-control" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="chapterStatus">ステータス</label>
                    <select id="chapterStatus" class="form-control">
                        <option value="not-started">未着手</option>
                        <option value="in-progress">執筆中</option>
                        <option value="completed">完了</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveChapter" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- シーン追加モーダル -->
    <div id="sceneModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>シーン作成</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sceneChapter">所属章</label>
                    <select id="sceneChapter" class="form-control" required>
                        <option value="">-- 章を選択 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sceneTitle">シーンタイトル</label>
                    <input type="text" id="sceneTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="sceneLocation">場所</label>
                    <input type="text" id="sceneLocation" class="form-control" placeholder="例: 王城、森の中">
                </div>
                <div class="form-group">
                    <label for="sceneTimeOfDay">時間帯</label>
                    <input type="text" id="sceneTimeOfDay" class="form-control" placeholder="例: 朝、夜">
                </div>
                <div class="form-group">
                    <label for="sceneCharacters">登場キャラクター</label>
                    <select id="sceneCharacters" class="form-control" multiple size="5">
                        <!-- キャラクター一覧を動的に生成 -->
                    </select>
                    <small class="form-help">Ctrlキーを押しながらクリックで複数選択</small>
                </div>
                <div class="form-group">
                    <label for="sceneContent">内容</label>
                    <textarea id="sceneContent" class="form-control" rows="8" placeholder="シーンの詳細を記述"></textarea>
                </div>
                <div class="form-group">
                    <label for="sceneNotes">メモ</label>
                    <textarea id="sceneNotes" class="form-control" rows="3" placeholder="メモ・アイデア"></textarea>
                </div>
                <div class="form-group">
                    <label for="sceneImage">画像 (任意)</label>
                    <div class="image-input-group">
                        <input type="text" id="sceneImage" class="form-control" placeholder="画像URLまたはBase64データ" readonly>
                        <button type="button" id="scene-image-select-btn" class="btn btn-secondary btn-sm">画像選択</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveScene" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- タイムラインイベント追加モーダル -->
    <div id="timelineEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>タイムラインイベント作成</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="timelineEventTitle">イベントタイトル</label>
                    <input type="text" id="timelineEventTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="timelineEventChapter">章</label>
                    <select id="timelineEventChapter" class="form-control">
                        <option value="">-- 章を選択（任意）--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timelineEventTimeOfDay">時間帯</label>
                    <select id="timelineEventTimeOfDay" class="form-control">
                        <option value="">-- 時間帯を選択（任意）--</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timelineEventTimestamp">タイムスタンプ</label>
                    <input type="text" id="timelineEventTimestamp" class="form-control" placeholder="例: 第1章開始、3日目午前">
                </div>
                <div class="form-group">
                    <label for="timelineEventDescription">説明</label>
                    <textarea id="timelineEventDescription" class="form-control" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="timelineEventImage">画像 (任意)</label>
                    <div class="image-input-group">
                        <input type="text" id="timelineEventImage" class="form-control" placeholder="画像URLまたはBase64データ" readonly>
                        <button type="button" id="timeline-image-select-btn" class="btn btn-secondary btn-sm">画像選択</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveTimelineEvent" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 画像選択モーダル -->
    <div id="imageSelectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>画像選択</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- タブ -->
                <div class="image-upload-tabs">
                    <button class="image-upload-tab-btn active" data-tab="url">URL指定</button>
                    <button class="image-upload-tab-btn" data-tab="file">ファイル</button>
                    <button class="image-upload-tab-btn" data-tab="library">ライブラリ</button>
                </div>

                <!-- URL指定タブ -->
                <div id="url-tab" class="image-upload-tab active">
                    <div class="form-group">
                        <label for="imageUrlInput">画像URL</label>
                        <input type="text" id="imageUrlInput" class="form-control" placeholder="https://example.com/image.png">
                    </div>
                    <button id="confirmImageUrl" class="btn btn-primary">この画像を使用</button>
                </div>

                <!-- ファイルタブ -->
                <div id="file-tab" class="image-upload-tab">
                    <div class="form-group">
                        <label for="imageFileInput">画像ファイル</label>
                        <input type="file" id="imageFileInput" class="form-control" accept="image/*">
                        <small class="form-help">選択すると自動的にBase64に変換されて設定されます</small>
                    </div>
                </div>

                <!-- ライブラリタブ -->
                <div id="library-tab" class="image-upload-tab">
                    <div class="media-library-section">
                        <h3>メディアライブラリから選択</h3>
                        <div id="mediaLibraryGrid" class="media-grid">
                            <!-- 動的に生成 -->
                        </div>
                        <button id="selectFromLibrary" class="btn btn-secondary" style="margin-top: 10px;">ライブラリを更新</button>
                    </div>
                    <hr>
                    <div class="media-library-section">
                        <h3>ライブラリに新規追加</h3>
                        <div class="form-group">
                            <label for="libraryImageName">画像名</label>
                            <input type="text" id="libraryImageName" class="form-control" placeholder="例: キャラクター立ち絵1">
                        </div>
                        <div class="form-group">
                            <label for="libraryImageFile">画像ファイル</label>
                            <input type="file" id="libraryImageFile" class="form-control" accept="image/*">
                        </div>
                        <button id="addToLibrary" class="btn btn-success">ライブラリに追加</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 関係性追加モーダル -->
    <div id="relationshipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="relationshipModalTitle">関係性を追加</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="relationship1">キャラクター1</label>
                    <select id="relationship1" class="form-control" required>
                        <option value="">-- キャラクターを選択 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="relationship2">キャラクター2</label>
                    <select id="relationship2" class="form-control" required>
                        <option value="">-- キャラクターを選択 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="relationshipType">関係性のタイプ</label>
                    <select id="relationshipType" class="form-control" required>
                        <option value="">-- 関係性を選択 --</option>
                        <option value="友人">友人</option>
                        <option value="親友">親友</option>
                        <option value="恋人">恋人</option>
                        <option value="家族">家族</option>
                        <option value="師弟">師弟</option>
                        <option value="ライバル">ライバル</option>
                        <option value="敵対">敵対</option>
                        <option value="仲間">仲間</option>
                        <option value="知人">知人</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="relationshipStrength">関係の強さ (0-100)</label>
                    <input type="range" id="relationshipStrength" class="form-control" min="0" max="100" value="50">
                    <span id="relationshipStrengthValue">50</span>
                </div>
                <div class="form-group">
                    <label for="relationshipDescription">関係の詳細</label>
                    <textarea id="relationshipDescription" class="form-control" rows="3" placeholder="二人の関係性について詳しく説明"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveRelationship" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- プロジェクト編集モーダル -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="projectModalTitle">プロジェクト編集</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="projectName">プロジェクト名</label>
                    <input type="text" id="projectName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="projectDescription">説明</label>
                    <textarea id="projectDescription" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveProject" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- モンスター追加モーダル -->
    <div id="monsterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>モンスター追加</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-form-columns">
                    <div class="form-column">
                        <div class="form-group">
                            <label for="monsterName">モンスター名</label>
                            <input type="text" id="monsterName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="monsterDangerInput">危険度</label>
                            <select id="monsterDangerInput" class="form-control">
                                <!-- マスタ管理から動的に生成 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="monsterRarityInput">レア度(モンスター)</label>
                            <select id="monsterRarityInput" class="form-control">
                                <!-- マスタ管理から動的に生成 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="monsterImageUrl">画像 (任意)</label>
                            <div class="image-input-group">
                                <input type="text" id="monsterImageUrl" class="form-control" placeholder="https://example.com/image.png">
                                <input type="file" id="monsterImageFile" accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('monsterImageFile').click()">ファイル</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="app.openMediaLibrary('monsterImageUrl')">ライブラリ</button>
                            </div>
                            <div id="monsterImagePreview" class="image-preview" style="display: none;"></div>
                            <small class="form-help">URL直接入力、ファイルアップロード、またはメディアライブラリから選択</small>
                        </div>
                        <div class="form-group">
                            <label for="monsterDescription">説明 (任意)</label>
                            <textarea id="monsterDescription" class="form-control" rows="3" placeholder="モンスターの説明を入力"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="monsterExp">獲得経験値</label>
                            <input type="number" id="monsterExp" class="form-control" min="0" value="0" placeholder="倒した時に獲得できる経験値">
                        </div>
                    </div>
                    <div class="form-column">
                        <h3>ステータス</h3>
                        <div id="monsterStatsFields"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveMonster" class="btn btn-primary">追加</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- アイテム追加モーダル -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>アイテム追加</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="itemName">アイテム名</label>
                    <input type="text" id="itemName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="itemType">種類</label>
                    <select id="itemType" class="form-control">
                        <!-- マスタ管理から動的に生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemRarity">レア度(アイテム)</label>
                    <select id="itemRarity" class="form-control">
                        <!-- マスタ管理から動的に生成 -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="itemImageUrl">画像 (任意)</label>
                    <div class="image-input-group">
                        <input type="text" id="itemImageUrl" class="form-control" placeholder="https://example.com/image.png">
                        <input type="file" id="itemImageFile" accept="image/*" style="display: none;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('itemImageFile').click()">ファイル</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="app.openMediaLibrary('itemImageUrl')">ライブラリ</button>
                    </div>
                    <div id="itemImagePreview" class="image-preview" style="display: none;"></div>
                    <small class="form-help">ファイルアップロード、URL入力、またはメディアライブラリから選択</small>
                </div>
                <div class="form-group">
                    <label for="itemDescription">説明 (任意)</label>
                    <textarea id="itemDescription" class="form-control" rows="2" placeholder="アイテムの説明を入力"></textarea>
                </div>
                <div class="form-group">
                    <label for="itemEffect">効果 (任意)</label>
                    <textarea id="itemEffect" class="form-control" rows="2" placeholder="アイテムの効果を入力"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveItem" class="btn btn-primary">追加</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- ドロップ設定モーダル -->
    <div id="dropModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>ドロップテーブル設定</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dropMonsterSelect">モンスター選択</label>
                    <select id="dropMonsterSelect" class="form-control">
                        <option value="">-- モンスターを選択 --</option>
                    </select>
                </div>
                <div id="dropItemsContainer" style="display: none;">
                    <h3>ドロップアイテム設定</h3>
                    <div id="dropItemsList"></div>
                    <button id="addDropItem" class="btn btn-success">➕ ドロップアイテム追加</button>
                    <button id="createNewItemFromDrop" class="btn btn-info">🆕 新規アイテムを作成して追加</button>
                    <div class="probability-total">
                        合計確率: <span id="totalProbability">0</span>%
                        <span id="probabilityWarning" class="info-message" style="display: none;">
                        </span>
                    </div>
                    <p class="help-text">
                        💡 確率は100%である必要はありません。<br>
                        ・合計100%未満: 何もドロップしない可能性<br>
                        ・合計100%超過: 複数アイテムのドロップ可能性<br>
                        ・個別100%超過: そのアイテムが複数個ドロップ<br>
                        ・最小設定: 0.00000001% (100億分の1)<br>
                        ・最大設定: 10000% (100倍)
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveDrops" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 鞄容量設定モーダル -->
    <div id="bagSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>鞄容量設定</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bagCapacity">最大容量</label>
                    <input type="number" id="bagCapacity" class="form-control" value="1000" min="1" max="999999">
                </div>
                <p class="help-text">
                    鞄の最大所持数を設定します。容量を超えた場合、新しいアイテムは追加されません。
                </p>
            </div>
            <div class="modal-footer">
                <button id="saveBagSettings" class="btn btn-primary">保存</button>
                <button class="btn btn-secondary close-modal">閉じる</button>
            </div>
        </div>
    </div>

    <!-- アイテム追加モーダル -->
    <div id="bagItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>アイテム追加</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bagItemSelect">アイテム</label>
                    <select id="bagItemSelect" class="form-control">
                        <option value="">-- アイテムを選択 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bagItemQuantity">個数</label>
                    <input type="number" id="bagItemQuantity" class="form-control" value="1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button id="addBagItem" class="btn btn-success">追加</button>
                <button class="btn btn-secondary close-modal">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- アイテム操作モーダル -->
    <div id="bagItemOperationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>アイテム操作</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="item-info">
                    <p><strong>アイテム:</strong> <span id="currentItemName"></span></p>
                    <p><strong>所持数:</strong> <span id="currentItemQuantity"></span>個</p>
                </div>
                <div class="form-group">
                    <label for="itemOperationQuantity">個数</label>
                    <input type="number" id="itemOperationQuantity" class="form-control" value="1" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <div class="modal-actions">
                    <button id="useBagItem" class="btn btn-primary">使用</button>
                    <button id="removeBagItem" class="btn btn-danger">削除</button>
                    <button class="btn btn-secondary close-modal">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/models.js"></script>
    <script src="js/character.js"></script>
    <script src="js/work.js"></script>
    <script src="js/plot.js"></script>
    <script src="js/master.js"></script>
    <script src="js/simulator.js"></script>
    <script src="js/bag.js"></script>
    <script src="js/media.js"></script>
    <script src="js/collaboration.js"></script>
    <script src="js/output.js"></script>
    <script src="js/templates.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
</body>
</html>

